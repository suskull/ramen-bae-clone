# Stripe Webhook Testing Guide

## Understanding Webhook Endpoints

You have **TWO separate webhook endpoints**:

### 1. Local Webhook (for development)
- **URL**: `http://localhost:54321/functions/v1/stripe-webhook`
- **Used for**: Local testing with Stripe CLI
- **Secret**: Generated by `stripe listen` command (starts with `whsec_`)

### 2. Production Webhook (for live site)
- **URL**: `https://nfydvfhrepavcyclzfrh.supabase.co/functions/v1/stripe-webhook`
- **Used for**: Real payments from production
- **Secret**: From Stripe Dashboard webhook settings (starts with `whsec_`)

## Current Issue

You're running:
```bash
stripe listen --forward-to localhost:54321/functions/v1/stripe-webhook
```

But then running:
```bash
stripe trigger payment_intent.succeeded
```

The `stripe trigger` command sends to the **Dashboard webhook** (production), not the CLI listener!

## Solution: Two Ways to Test

### Method 1: Test Locally with Stripe CLI (Recommended)

#### Step 1: Start Stripe CLI Listener
```bash
stripe listen --forward-to http://localhost:54321/functions/v1/stripe-webhook
```

This will output something like:
```
> Ready! Your webhook signing secret is whsec_abc123xyz... (^C to quit)
```

#### Step 2: Copy the Webhook Secret
Add it to your `.env.local`:
```bash
STRIPE_WEBHOOK_SECRET=whsec_abc123xyz...
```

#### Step 3: Restart Your Local Edge Function
```bash
# Stop current function (Ctrl+C)
supabase functions serve stripe-webhook --env-file .env.local
```

#### Step 4: Trigger Test Events
In a **NEW terminal** (keep stripe listen running):
```bash
stripe trigger payment_intent.succeeded
```

#### Step 5: Check Logs
You should see the webhook event in:
- The `stripe listen` terminal
- Your Edge Function logs

### Method 2: Test Production Webhook

#### Step 1: Deploy Webhook Function
```bash
supabase functions deploy stripe-webhook
```

#### Step 2: Set Production Webhook Secret
1. Go to [Stripe Dashboard â†’ Webhooks](https://dashboard.stripe.com/webhooks)
2. Find your production webhook endpoint
3. Click "Reveal" on the signing secret
4. Copy the secret (starts with `whsec_`)

```bash
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_your_production_secret
```

#### Step 3: Test with Real Payment
Create a real payment intent and complete it with a test card.

#### Step 4: Check Webhook Delivery
Go to Stripe Dashboard â†’ Webhooks â†’ Your endpoint â†’ Recent deliveries

## Quick Test Script

Create `test-webhook-local.sh`:

```bash
#!/bin/bash

echo "ðŸ§ª Testing Local Webhook..."
echo ""

# Check if stripe listen is running
if ! pgrep -f "stripe listen" > /dev/null; then
    echo "âŒ Stripe CLI is not listening!"
    echo "   Run: stripe listen --forward-to http://localhost:54321/functions/v1/stripe-webhook"
    exit 1
fi

echo "âœ… Stripe CLI is listening"
echo ""

# Trigger test event
echo "ðŸ“¤ Triggering payment_intent.succeeded..."
stripe trigger payment_intent.succeeded

echo ""
echo "âœ… Event triggered! Check your logs:"
echo "   - Stripe CLI terminal"
echo "   - Edge Function logs"
```

## Common Issues

### Issue 1: "Failed to connect to remote host"
**Cause**: Trying to trigger to production URL but function not deployed or secret not set

**Fix**: 
- For local testing: Use `stripe listen` + `stripe trigger`
- For production: Deploy function and set secrets first

### Issue 2: "Invalid signature"
**Cause**: Webhook secret doesn't match

**Fix**:
- Local: Use secret from `stripe listen` output
- Production: Use secret from Stripe Dashboard

### Issue 3: "No webhook secret configured"
**Cause**: `STRIPE_WEBHOOK_SECRET` not set in environment

**Fix**:
```bash
# Local
echo "STRIPE_WEBHOOK_SECRET=whsec_..." >> .env.local

# Production
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_...
```

## Recommended Workflow

### During Development (Local)
1. Start local Supabase: `supabase start`
2. Start webhook function: `supabase functions serve stripe-webhook --env-file .env.local`
3. Start Stripe CLI: `stripe listen --forward-to http://localhost:54321/functions/v1/stripe-webhook`
4. Copy webhook secret to `.env.local`
5. Restart webhook function
6. Test: `stripe trigger payment_intent.succeeded`

### For Production
1. Deploy function: `supabase functions deploy stripe-webhook`
2. Set webhook secret: `supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_...`
3. Create real payment and complete it
4. Check Stripe Dashboard for webhook delivery

## Debugging Tips

### Check if webhook function is running locally
```bash
curl http://localhost:54321/functions/v1/stripe-webhook
# Should return error (no signature) but confirms it's running
```

### Check production webhook
```bash
curl https://nfydvfhrepavcyclzfrh.supabase.co/functions/v1/stripe-webhook
# Should return error (no signature) but confirms it's deployed
```

### View webhook logs
```bash
# Local
# Check terminal where you ran supabase functions serve

# Production
# Go to Supabase Dashboard â†’ Edge Functions â†’ stripe-webhook â†’ Logs
```

## Summary

- **Local testing**: Use `stripe listen` + `stripe trigger`
- **Production testing**: Use real payments or Stripe Dashboard test mode
- **Never mix**: Don't trigger to production while listening locally
- **Always match**: Webhook URL and webhook secret must match
